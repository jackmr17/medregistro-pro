<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Usuario ‚Äì MedRegistro Pro</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
    }
    .sidebar-link.active {
      background: rgba(59, 130, 246, 0.15);
      color: #1d4ed8;
    }
  </style>
</head>
<body class="min-h-screen flex">

  <!-- SIDEBAR -->
  <aside class="w-64 bg-white shadow-lg flex flex-col">
    <div class="px-6 py-5 border-b border-gray-200 flex items-center gap-2">
      <i class="fa-solid fa-stethoscope text-2xl text-blue-600"></i>
      <div>
        <div class="font-bold text-lg text-gray-900">MedRegistro Pro</div>
        <div class="text-xs text-gray-500">Panel Paciente</div>
      </div>
    </div>

    <nav class="flex-1 px-3 py-4 space-y-1">
      <button data-tab="resumen"
              class="sidebar-link w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm text-gray-700 hover:bg-gray-100 active">
        <i class="fa-solid fa-gauge"></i> Resumen
      </button>

      <button data-tab="activas"
              class="sidebar-link w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm text-gray-700 hover:bg-gray-100">
        <i class="fa-solid fa-calendar-check"></i> Citas activas
      </button>

      <button data-tab="historial"
              class="sidebar-link w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm text-gray-700 hover:bg-gray-100">
        <i class="fa-solid fa-clock-rotate-left"></i> Historial
      </button>

      <button onclick="window.location.href='Clinicas.html'"
              class="w-full flex items-center gap-3 px-3 py-2 mt-4 rounded-lg text-sm text-blue-700 bg-blue-50 hover:bg-blue-100">
        <i class="fa-solid fa-calendar-plus"></i> Reservar nueva cita
      </button>
    </nav>

    <div class="px-4 py-4 border-t border-gray-200 text-xs text-gray-500">
      <div id="userInfo" class="mb-2"></div>
      <button id="logoutBtn"
              class="w-full text-left flex items-center gap-2 text-red-600 hover:text-red-700 text-sm">
        <i class="fa-solid fa-right-from-bracket"></i> Cerrar sesi√≥n
      </button>
    </div>
  </aside>

  <!-- CONTENIDO PRINCIPAL -->
  <main class="flex-1 p-6 lg:p-8">
    <header class="flex flex-wrap justify-between items-center gap-4 mb-6">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Hola, <span id="userNombre">Paciente</span> üëã</h1>
        <p class="text-gray-600 text-sm">
          Aqu√≠ puedes ver tus citas m√©dicas, historial y gestionar tus reservas.
        </p>
      </div>
      <button onclick="window.location.href='Clinicas.html'"
              class="px-3 py-1.5 text-xs md:text-sm rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100">
        Volver al inicio
      </button>
    </header>

    <!-- RESUMEN -->
    <section id="tab-resumen" class="tab-content">
      <div class="grid md:grid-cols-3 gap-4 mb-8">
        <div class="bg-white rounded-xl shadow p-4 flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
            <i class="fa-solid fa-calendar-check text-blue-600"></i>
          </div>
          <div>
            <p class="text-xs text-gray-500">Citas activas</p>
            <p id="cardCitasActivas" class="text-xl font-semibold text-gray-900">0</p>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow p-4 flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
            <i class="fa-solid fa-user-doctor text-green-600"></i>
          </div>
          <div>
            <p class="text-xs text-gray-500">√öltima especialidad</p>
            <p id="cardUltEspecialidad" class="text-sm font-semibold text-gray-900">-</p>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow p-4 flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center">
            <i class="fa-solid fa-hospital text-purple-600"></i>
          </div>
          <div>
            <p class="text-xs text-gray-500">√öltima cl√≠nica</p>
            <p id="cardUltClinica" class="text-sm font-semibold text-gray-900">-</p>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Pr√≥ximas citas</h2>
        <div id="tablaProximas"></div>
      </div>
    </section>

    <!-- CITAS ACTIVAS -->
    <section id="tab-activas" class="tab-content hidden">
      <div class="bg-white rounded-xl shadow p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Citas activas</h2>
        <p class="text-sm text-gray-500 mb-4">
          Puedes cancelar una cita solo con al menos 24 horas de anticipaci√≥n.
        </p>
        <div id="tablaActivas"></div>
      </div>
    </section>

    <!-- HISTORIAL -->
    <section id="tab-historial" class="tab-content hidden">
      <div class="bg-white rounded-xl shadow p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Historial de citas</h2>
        <div id="tablaHistorial"></div>
      </div>
    </section>
  </main>

  <!-- MODAL CONFIRMACI√ìN CANCELACI√ìN -->
  <div id="modalConfirmCancel" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full text-center">
      <i class="fa-solid fa-circle-exclamation text-yellow-500 text-4xl mb-3"></i>
      <h2 class="text-xl font-semibold text-gray-900 mb-2">¬øCancelar esta reserva?</h2>
      <p class="text-sm text-gray-600 mb-4">
        Solo puedes cancelar con al menos 24 horas de anticipaci√≥n. Esta acci√≥n no se puede deshacer.
      </p>
      <div class="flex flex-col gap-2 sm:flex-row sm:justify-center">
        <button id="btnCancelarNo"
                class="w-full sm:w-auto px-4 py-2 rounded-lg border border-gray-300 text-sm text-gray-700 hover:bg-gray-100">
          No, volver
        </button>
        <button id="btnCancelarSi"
                class="w-full sm:w-auto px-4 py-2 rounded-lg bg-red-600 text-sm text-white font-semibold hover:bg-red-700">
          S√≠, cancelar reserva
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL NOTIFICACI√ìN -->
  <div id="modalNotif" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full text-center">
      <i id="notifIcon" class="fa-solid text-4xl mb-3"></i>
      <h2 id="notifTitle" class="text-xl font-semibold text-gray-900 mb-2">T√≠tulo</h2>
      <p id="notifMessage" class="text-sm text-gray-600 mb-4">Mensaje</p>
      <button id="notifCloseBtn"
              class="w-full px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700">
        Aceptar
      </button>
    </div>
  </div>

  <script>
    // ======================
    // MODALES: helpers
    // ======================
    let reservaIdParaCancelar = null;

    function mostrarModalConfirmacion(idReserva) {
      reservaIdParaCancelar = idReserva;
      const modal = document.getElementById('modalConfirmCancel');
      if (modal) modal.classList.remove('hidden');
    }

    function cerrarModalConfirmacion() {
      const modal = document.getElementById('modalConfirmCancel');
      if (modal) modal.classList.add('hidden');
      reservaIdParaCancelar = null;
    }

    function mostrarNotificacion(titulo, mensaje, tipo = 'success') {
      const modal = document.getElementById('modalNotif');
      const icon = document.getElementById('notifIcon');
      const titleEl = document.getElementById('notifTitle');
      const msgEl = document.getElementById('notifMessage');

      if (!modal || !icon || !titleEl || !msgEl) return;

      titleEl.textContent = titulo;
      msgEl.textContent = mensaje;

      // Reset clases del icono
      icon.className = 'fa-solid text-4xl mb-3';
      if (tipo === 'success') {
        icon.classList.add('fa-circle-check', 'text-green-500');
      } else {
        icon.classList.add('fa-circle-exclamation', 'text-red-500');
      }

      modal.classList.remove('hidden');
    }

    function cerrarNotificacion() {
      const modal = document.getElementById('modalNotif');
      if (modal) modal.classList.add('hidden');
    }

    async function confirmarCancelacionReserva() {
      if (!reservaIdParaCancelar) return;
      const id = reservaIdParaCancelar;
      cerrarModalConfirmacion();

      try {
        const res = await fetch(`/api/reservas/${id}/cancelar`, { method: 'POST' });
        const data = await res.json();

        if (!res.ok || !data.ok) {
          mostrarNotificacion(
            'No se pudo cancelar la reserva',
            data.mensaje || 'Intenta nuevamente m√°s tarde.',
            'error'
          );
        } else {
          mostrarNotificacion(
            'Reserva cancelada',
            'Tu reserva fue cancelada correctamente.',
            'success'
          );
        }

        await cargarReservas();
      } catch (err) {
        console.error(err);
        mostrarNotificacion(
          'Error de conexi√≥n',
          'No pudimos conectar con el servidor. Intenta nuevamente.',
          'error'
        );
      } finally {
        reservaIdParaCancelar = null;
      }
    }

    // ======================
    // Usuario logueado
    // ======================
    function getUser() {
      try {
        return JSON.parse(localStorage.getItem("mr_user") || "null");
      } catch { return null; }
    }

    const user = getUser();
    if (!user) {
      window.location.href = 'IniciarSesion.html';
    } else {
      document.getElementById('userNombre').textContent = user.nombres;
      document.getElementById('userInfo').textContent = user.correo || '';
    }

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await fetch('/api/auth/logout', { method: 'POST' });
      localStorage.clear();
      window.location.href = 'IniciarSesion.html';
    });

    // ======================
    // Tabs laterales
    // ======================
    const links = document.querySelectorAll('.sidebar-link');
    const tabs  = document.querySelectorAll('.tab-content');

    links.forEach(link => {
      link.addEventListener('click', () => {
        const tab = link.getAttribute('data-tab');
        links.forEach(l => l.classList.remove('active'));
        link.classList.add('active');

        tabs.forEach(sec => {
          sec.classList.toggle('hidden', sec.id !== ('tab-' + tab));
        });
      });
    });

    // ======================
    // Helpers de fecha / hora
    // ======================
    function parseFechaHora(fecha, hora) {
      const [year, month, day] = fecha.split('-').map(Number);
      const [hh, mm] = hora.split(':').map(Number);
      return new Date(year, month - 1, day, hh, mm || 0, 0);
    }

    function esFutura(fecha, hora) {
      const ahora = new Date();
      const fechaCita = parseFechaHora(fecha, hora);
      return fechaCita > ahora;
    }

    // Calcula en cu√°nto tiempo m√°s ser√° la cita (d√≠as / horas / minutos)
    function textoTiempoRestante(fecha, hora) {
      const ahora = new Date();
      const fechaCita = parseFechaHora(fecha, hora);
      const diffMs = fechaCita - ahora;

      if (diffMs <= 0) return 'Ya ocurri√≥';

      const diffMin = Math.floor(diffMs / 60000);
      const dias    = Math.floor(diffMin / (60 * 24));
      const horas   = Math.floor((diffMin % (60 * 24)) / 60);
      const minutos = diffMin % 60;

      if (dias > 0) {
        return dias + ' d√≠a(s) y ' + horas + ' h';
      } else if (horas > 0) {
        return horas + ' h ' + minutos + ' min';
      } else {
        return minutos + ' min';
      }
    }

    // ======================
    // Tabla de reservas
    // ======================
    function crearTablaReservas(idContenedor, reservas, mostrarAccionCancelar) {
      const cont = document.getElementById(idContenedor);
      if (!cont) return;

      if (!reservas || reservas.length === 0) {
        cont.innerHTML = '<p class="text-sm text-gray-500">No hay registros disponibles.</p>';
        return;
      }

      let html = `
        <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="border-b bg-gray-50 text-gray-700">
              <th class="text-left px-3 py-2">Fecha</th>
              <th class="text-left px-3 py-2">Hora</th>
              <th class="text-left px-3 py-2">En</th>
              <th class="text-left px-3 py-2">Cl√≠nica</th>
              <th class="text-left px-3 py-2">Especialidad</th>
              <th class="text-left px-3 py-2">Doctor</th>
              <th class="text-left px-3 py-2">Estado</th>
              <th class="text-left px-3 py-2">Monto</th>
              ${mostrarAccionCancelar ? '<th class="px-3 py-2 text-center">Acci√≥n</th>' : ''}
            </tr>
          </thead>
          <tbody>
      `;

      reservas.forEach(r => {
        const tiempo = textoTiempoRestante(r.fecha, r.hora);
        html += `
          <tr class="border-b hover:bg-gray-50">
            <td class="px-3 py-2">${r.fecha}</td>
            <td class="px-3 py-2">${r.hora}</td>
            <td class="px-3 py-2">${tiempo}</td>
            <td class="px-3 py-2">${r.clinica}</td>
            <td class="px-3 py-2">${r.especialidad}</td>
            <td class="px-3 py-2">${r.doctor}</td>
            <td class="px-3 py-2">${r.estado}</td>
            <td class="px-3 py-2">$${r.monto}</td>
            ${mostrarAccionCancelar ? `
            <td class="px-3 py-2 text-center">
              <button data-id="${r.id}"
                      class="btn-cancelar text-xs bg-red-50 text-red-700 px-3 py-1 rounded-full hover:bg-red-100">
                Cancelar
              </button>
            </td>` : ''}
          </tr>
        `;
      });

      html += `</tbody></table></div>`;
      cont.innerHTML = html;

      if (mostrarAccionCancelar) {
        cont.querySelectorAll('.btn-cancelar').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-id');
            mostrarModalConfirmacion(id);
          });
        });
      }
    }

    // ======================
    // Cargar reservas del usuario
    // ======================
    async function cargarReservas() {
      try {
        const res  = await fetch('/api/reservas/mias');
        const data = await res.json();

        if (!res.ok || !data.ok) {
          console.error(data);
          return;
        }

        const reservas = data.reservas || [];

        // Ordenar por fecha/hora asc para "pr√≥ximas"
        const reservasOrdenadasAsc = [...reservas].sort((a, b) => {
          const da = parseFechaHora(a.fecha, a.hora);
          const db = parseFechaHora(b.fecha, b.hora);
          return da - db;
        });

        // Activas = futuras y estado pendiente/pagada
        const activas = reservasOrdenadasAsc.filter(r =>
          esFutura(r.fecha, r.hora) &&
          (r.estado === 'pendiente' || r.estado === 'pagada')
        );

        // Pr√≥ximas (por ejemplo 5)
        const proximas = activas.slice(0, 5);

        // Historial = todas (ya vienen ordenadas DESC desde el backend)
        const historial = reservas;

        // Tarjetas resumen
        const cardCitasActivas = document.getElementById('cardCitasActivas');
        const cardUltEsp       = document.getElementById('cardUltEspecialidad');
        const cardUltClinica   = document.getElementById('cardUltClinica');

        if (cardCitasActivas) cardCitasActivas.textContent = activas.length;

        if (reservas.length > 0) {
          const ultima = reservas[0]; // backend: ORDER BY fecha DESC, hora DESC
          if (cardUltEsp)     cardUltEsp.textContent     = ultima.especialidad || '-';
          if (cardUltClinica) cardUltClinica.textContent = ultima.clinica || '-';
        } else {
          if (cardUltEsp)     cardUltEsp.textContent     = '-';
          if (cardUltClinica) cardUltClinica.textContent = '-';
        }

        // Tablas
        crearTablaReservas('tablaProximas', proximas, false);
        crearTablaReservas('tablaActivas',  activas,  true);
        crearTablaReservas('tablaHistorial', historial, false);

      } catch (err) {
        console.error('Error al cargar reservas:', err);
      }
    }

    // ======================
    // DOMContentLoaded
    // ======================
    document.addEventListener('DOMContentLoaded', () => {
      cargarReservas();

      const btnNo = document.getElementById('btnCancelarNo');
      const btnSi = document.getElementById('btnCancelarSi');
      const btnCloseNotif = document.getElementById('notifCloseBtn');

      if (btnNo) btnNo.addEventListener('click', cerrarModalConfirmacion);
      if (btnSi) btnSi.addEventListener('click', confirmarCancelacionReserva);
      if (btnCloseNotif) btnCloseNotif.addEventListener('click', cerrarNotificacion);
    });
  </script>
</body>
</html>
